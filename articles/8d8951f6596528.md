---
title: "Net::ProtocRetryErrorã®ã‚¨ãƒ©ãƒ¼ã‚’ãªãã™ãŸã‚ã«net-httpã®gemã‚’è¿½åŠ ã™ã‚‹"
emoji: "ğŸ›"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [rails, ruby, net-http]
published: false
---

## å‰æ
- Rubyï¼š2.7.1
- railsï¼š6.0.5

## çµè«–ã‹ã‚‰
Gemfileã«ä»¥ä¸‹ã‚’è¿½åŠ ã™ã‚‹

```Gemfile
gem 'net-http'
```

## å•é¡Œ
rails sæ™‚ãªã©ã®ç«‹ã¡ä¸Šã’æ™‚ã«ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼

```shell
app_1      | /usr/local/lib/ruby/2.7.0/net/protocol.rb:66: warning: already initialized constant Net::ProtocRetryError
app_1      | /usr/local/lib/ruby/gems/2.7.0/gems/net-protocol-0.2.1/lib/net/protocol.rb:68: warning: previous definition of ProtocRetryError was here
app_1      | /usr/local/lib/ruby/2.7.0/net/protocol.rb:206: warning: already initialized constant Net::BufferedIO::BUFSIZE
app_1      | /usr/local/lib/ruby/gems/2.7.0/gems/net-protocol-0.2.1/lib/net/protocol.rb:214: warning: previous definition of BUFSIZE was here
app_1      | /usr/local/lib/ruby/2.7.0/net/protocol.rb:503: warning: already initialized constant Net::NetPrivate::Socket
app_1      | /usr/local/lib/ruby/gems/2.7.0/gems/net-protocol-0.2.1/lib/net/protocol.rb:541: warning: previous definition of Socket was here
```

## å•é¡ŒãŒç”Ÿã˜ã‚‹ç†ç”±
ref: https://github.com/ruby/net-imap/issues/16#issuecomment-803086765

> - When theÂ `faraday-net_http`Â gem is required, it then requiresÂ `net/http`.
> - Then the stdlib version ofÂ `net/http`Â is loaded, since bundler doesn't knowÂ `net-http`Â is a gem dependency, so it doesn't add the gemified version to to theÂ `$LOAD_PATH`.
> - Then the stdlib version ofÂ `net/http`Â requiresÂ `net/protocol`Â relatively, since that's what it used to happen before these gems were gemified. SeeÂ [[ruby/net-http@6da598e](https://github.com/ruby/net-http/commit/6da598e928f0cc817b1d17209dfaf7fed4c9dff7)](https://github.com/ruby/net-http/commit/6da598e928f0cc817b1d17209dfaf7fed4c9dff7). So the stdlib version ofÂ `net/protocol`Â is loaded.
> - Then whenÂ `net-imap`Â is required, it also usesÂ `net-protocol`Â but this time the gemified version ofÂ `net-protocol`Â is used, becauseÂ `net-imap`Â properly declares it as a dependency, soÂ `bundler`Â knows about it and has put it in theÂ `$LOAD_PATH`. This is what causes the double load ofÂ `net/protocol`.


### ã¤ã¾ã‚Š
`faraday-net_http`ãŒè¦æ±‚ã•ã‚Œã‚‹ã¨ã€`net/http`ãŒå¿…è¦ã«ãªã‚‹ã€‚

ã—ã‹ã—ã€`net-http`ãŒgemã®ä¾å­˜é–¢ä¿‚ã§ã‚ã‚‹ã“ã¨ã‚’BundlerãŒèªè­˜ã—ã¦ã„ãªã„ãŸã‚ã€gemåŒ–ã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒ$LOAD_PATHã«è¿½åŠ ã•ã‚Œãšã€æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®`net/http`ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã€‚

ãã—ã¦ã€æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒª`net/http`ã¯`net/protocol`ã‚’å¿…è¦ã¨ã™ã‚‹ã®ã§`net/protocol`ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã€‚

ãã—ã¦ã€`net-imap`ã‚‚ã¾ãŸã€`net-protocol`ã‚’å¿…è¦ã¨ã™ã‚‹ã€‚

ãªã®ã§`net-protocol`ãŒäºŒé‡ã§å‘¼ã°ã‚Œã‚‹ã®ã§ã‚¨ãƒ©ãƒ¼ã¨ãªã‚‹ã€‚

ã¨ãªã‚‹ã¨ã€ãã‚‚ãã‚‚æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®`net/http`ã‚’ä½¿ã‚ã›ãªã‘ã‚Œã°ã„ã„ã€‚ã¤ã¾ã‚Šã€gemç‰ˆã®`net-http`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚Œã°ã„ã„ã€‚ã¨ã„ã†æ„Ÿã˜ã€‚
