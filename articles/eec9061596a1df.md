---
title: "mappingã«ã¦ã¨ã‚ã‚‹fieldã«multi fieldã‚’è¿½åŠ ã‚’ã—ãŸå¾Œã€partial reindexã§ã¯ãªãœæœŸå¾…ã™ã‚‹æŒ™å‹•ãŒå¾—ã‚‰ã‚Œãªã„ã‹"
emoji: "ğŸ¦"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['elasticsearch', 'opensearch', 'searchkick']
published: false
---

## ã¯ã˜ã‚ã«
ã“ã‚“ã«ã¡ã¯ï¼GMOãƒšãƒ‘ãƒœã§webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚’ã—ã¦ã„ã‚‹ã€[kazu](https://twitter.com/kazuhitonakayam)ã§ã™ã€‚

æœ¬è¨˜äº‹ã¯ã€GMOãƒšãƒ‘ãƒœã®2023å¹´åº¦ã®ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼21æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
https://adventar.org/calendars/8634ã€€

## çµè«–
æ—¢å­˜ã®mappingã«ã‚ã‚‹fieldã«å¯¾ã—ã¦ã€multi fieldã‚’è¿½åŠ ã—ãŸå ´åˆã€documentã«ã¤ã„ã¦å†indexï¼ˆbulk_indexãªã©ï¼‰ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚updateã§ã¯mappingã®å¤‰æ›´ã¯åæ˜ ã•ã‚Œãªã„ã€‚

```ruby
def bulk_index(records)
  return if records.empty?

  notify_bulk(records, "Import") do
    queue_index(records)
  end
end
```
https://github.com/ankane/searchkick/blob/74fd743f47eea99bfb33cf9339dccfc8ca4f5fc0/lib/searchkick/index.rb#L158-L164

## å‰æ
- Elasticsearch
- [seachkick](https://github.com/ankane/searchkick)

ã‚’ä½¿ã£ã¦æ¤œç´¢æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ECã‚µã‚¤ãƒˆã‚’å‰æã¨ã—ã¾ã™ã€‚

ãã—ã¦ã€å½“ECã‚µã‚¤ãƒˆã«ãŠã„ã¦ã€å•†å“ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹indexãŒã‚ã‚‹ã¨ã—ã¦ã€ã‚‚ã¨ã‚‚ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªmappingå®šç¾©ãŒã‚ã£ãŸã¨ã—ã¾ã™ã€‚

```json
{
  "mappings": {
    "properties": {
      "id": {
        "type": "integer"
      },
    }
  }
}
```

ãã“ã§ã€æ–°ãŸã«ã€ã“ã®`id`ã¨ã„ã†fieldã«å¯¾ã—ã¦ã€[multi field](https://www.elastic.co/guide/en/elasticsearch/reference/current/multi-fields.html)ã‚’è¿½åŠ ã—ã¦ã€æ¤œç´¢æ™‚ã«ã¯`text`ã¨ã—ã¦æ¤œç´¢ã§ãã‚‹ã‚ˆã†ã«ã—ãŸã„ã¨ãªã£ãŸæ™‚ã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªmappingå®šç¾©ã‚’è¿½åŠ ã—ã¾ã™ã€‚ï¼ˆmulti fieldã®è¿½åŠ ã«ã¯[update mapping API](https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-put-mapping.html)ãŒä¾¿åˆ©ã§ã™ï¼‰

ã“ã‚Œã¯ã€`id`ã¨ã—ã¦ã¯integerå‹ã§æ ¼ç´ã™ã‚‹ãŒã€`id.analyzed`ã¨ã—ã¦ã¯textå‹ã§æ ¼ç´ã™ã‚‹ã¨ã„ã†å®šç¾©ã§ã™ã€‚

```json
{
  "mappings": {
    "properties": {
      "id": {
        "type": "integer",
        "fields": {
          "analyzed": {
            "type": "text"
          }
        }
      },
    }
  }
}
```

## èµ·ã“ã£ã¦ã„ãŸå•é¡Œ
mappingå®šç¾©ã‚’è¿½åŠ ã—ãŸå¾Œã€[partial reindex](https://github.com/ankane/searchkick?tab=readme-ov-file#partial-reindexing)ã‚’ç”¨ã„ã¦ã€`id`fieldã«ã¤ã„ã¦ã®ã¿ã€indexå†…ã®å…¨ã¦ã®documentã‚’æ›´æ–°ã—ã‚ˆã†ã¨ã—ã¾ã—ãŸã€‚ã“ã‚Œã¯ã€ç‰¹å®šã®fieldã«ã¤ã„ã¦ã®ã¿ã€documentã‚’æ›´æ–°ã™ã‚‹ã“ã¨ãŒã§ãã‚‹æ©Ÿèƒ½ã§ã™ã€‚

```ruby
class Product < ApplicationRecord
  def search_data
    {
      name: name,
      category: category
    }.merge(prices_data)
  end

  def prices_data
    {
      price: price,
      sale_price: sale_price
    }
  end
end
```

```ruby
Product.reindex(:prices_data)
```

ç§ã¯ã€mappingæ›´æ–°å¾Œã€`id`fieldã«ã¤ã„ã¦ã®ã¿ã€partial reindexã‚’ä½¿ã£ã¦ã€ã™ã¹ã¦ã®documentã‚’æ›´æ–°ã™ã‚Œã°ã€æœŸå¾…é€šã‚Šã€æ¤œç´¢æ™‚ã«ã¯`text`ã¨ã—ã¦æ¤œç´¢ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã¨è€ƒãˆã¦ã„ã¾ã—ãŸã€‚ã—ã‹ã—ã€å®Ÿéš›ã«ã¯ã€æ¤œç´¢ã¯æ©Ÿèƒ½ã—ãªã‹ã£ãŸã®ã§ã™ã€‚

## ãªãœpartial reindexã§ã¯mappingæ›´æ–°å¾Œã®mappingå®šç¾©ãŒåæ˜ ã•ã‚Œãªã„ã®ã‹
ã“ã‚Œã¯ã€partial reindexã§ã¯ã€searchkickã®å†…éƒ¨å®Ÿè£…ã¨ã—ã¦ã€updateãŒæœ€çµ‚çš„ã«å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã§ã™ã€‚

```ruby
# ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦ã€idã«ã¤ã„ã¦ã®ã¿ã€partial reindexã‚’å®Ÿè¡Œã—ãŸå ´åˆ
Product.reindex(:id)
```

```ruby
def reindex(method_name = nil, mode: nil, refresh: false)
  self.class.searchkick_index.reindex([self], method_name: method_name, mode: mode, refresh: refresh, single: true)
end
```
[https://github.com/ankane/searchkick/blob/74fd743f47eea99bfb33cf9339dccfc8ca4f5fc0/lib/searchkick/model.rb#L30-L32](https://github.com/ankane/searchkick/blob/74fd743f47eea99bfb33cf9339dccfc8ca4f5fc0/lib/searchkick/model.rb#L30-L32)

```ruby
if method_name || (scoped && !full)
  mode = options.delete(:mode) || :inline

  import_scope(relation, method_name: method_name, mode: mode)
```
[https://github.com/ankane/searchkick/blob/74fd743f47eea99bfb33cf9339dccfc8ca4f5fc0/lib/searchkick/index.rb#L232-L239](https://github.com/ankane/searchkick/blob/74fd743f47eea99bfb33cf9339dccfc8ca4f5fc0/lib/searchkick/index.rb#L232-L239)

```ruby
def import_scope(relation, **options)
  relation_indexer.reindex(relation, **options)
end
```
[https://github.com/ankane/searchkick/blob/74fd743f47eea99bfb33cf9339dccfc8ca4f5fc0/lib/searchkick/index.rb#L265-L267](https://github.com/ankane/searchkick/blob/74fd743f47eea99bfb33cf9339dccfc8ca4f5fc0/lib/searchkick/index.rb#L265-L267)

```ruby
in_batches(relation) do |items|
  record_indexer.reindex(items, **reindex_options)
end
```
[https://github.com/ankane/searchkick/blob/74fd743f47eea99bfb33cf9339dccfc8ca4f5fc0/lib/searchkick/relation_indexer.rb#L44-L46](https://github.com/ankane/searchkick/blob/74fd743f47eea99bfb33cf9339dccfc8ca4f5fc0/lib/searchkick/relation_indexer.rb#L44-L46)


```ruby
when true, :inline
  index_records, other_records = records.partition { |r| index_record?(r) }
  import_inline(index_records, !full ? other_records : [], method_name: method_name, single: single)
```
[https://github.com/ankane/searchkick/blob/74fd743f47eea99bfb33cf9339dccfc8ca4f5fc0/lib/searchkick/record_indexer.rb#L52-L54](https://github.com/ankane/searchkick/blob/74fd743f47eea99bfb33cf9339dccfc8ca4f5fc0/lib/searchkick/record_indexer.rb#L52-L54)


```ruby
def import_inline(index_records, delete_records, method_name:, single:)
  return if index_records.empty? && delete_records.empty?

  maybe_bulk(index_records, delete_records, method_name, single) do
    if index_records.any?
      if method_name
        index.bulk_update(index_records, method_name)
      else
        index.bulk_index(index_records)
      end
    end

    if delete_records.any?
      index.bulk_delete(delete_records)
    end
  end
end
```
[https://github.com/ankane/searchkick/blob/74fd743f47eea99bfb33cf9339dccfc8ca4f5fc0/lib/searchkick/record_indexer.rb#L88-L105](https://github.com/ankane/searchkick/blob/74fd743f47eea99bfb33cf9339dccfc8ca4f5fc0/lib/searchkick/record_indexer.rb#L88-L105)

ã¤ã¾ã‚Šã€partial reindexã¨ã¯ã¤ã¾ã‚Šã€`method_name`ã‚’æŒ‡å®šã—ã¦ã€documentã‚’reindexã—ã¦ã„ãã‚‚ã®ã§ã‚ã‚Šã€`method name`ãŒã‚ã‚‹ã¨ãã€`index.bulk_update`ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¨ã„ã†ã“ã¨ãŒä¸Šã‹ã‚‰ã‚ã‹ã‚Šã¾ã™ã€‚

## ã§ã¯ã€bulk_updateã¨bulk_indexã®å·®ç•°
ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ›¸ã„ã¦ã‚ã‚‹ãŒã€updateã¯ã€documentã®å˜ãªã‚‹æ›´æ–°ã‚’è¡Œã†ã‚‚ã®ã§ã‚ã‚Šã€indexã¯ã€documentã®è¿½åŠ ï¼ˆæ—¢ã«ã‚ã‚Œã°æ›´æ–°ã—ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã™ã‚‹ï¼‰ã‚’è¡Œã†ã‚‚ã®ã§ã‚ã‚‹ã€‚

- update
  - > Updates a document using the specified script.
  - https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-update.html#doc_as_upsert
- index
  - > Adds a JSON document to the specified data stream or index and makes it searchable. If the target is an index and the document already exists, the request updates the document and increments its version.
  - https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-index_.html

ã‚ˆã£ã¦ã€mappingã‚’æ›´æ–°ã—ãŸå¾Œã¯ã€å˜ãªã‚‹updateã§ã¯ã€å¤‰æ›´å‰ã®mappingã§æ›´æ–°ã•ã‚Œã¦ã—ã¾ã†ã®ã§ã€å¤‰æ›´å¾Œã®mappingã§æ›´æ–°ã™ã‚‹ãŸã‚ã«ã¯ã€indexã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚
